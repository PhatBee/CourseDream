@startuml
!theme plain

' Khai báo các thành phần tham gia
actor "Student/Instructor" as User
boundary "Page UI" as UI
    control "Router & Middleware" as Middleware
    control "User Controller" as Controller
    participant "User Service" as Service
    entity ":User" as Entity
    participant "Cloudinary" as Cloud

' Bắt đầu luồng
User -> UI: Nhập thông tin & chọn ảnh mới\n(Bấm nút "Cập nhật")
activate UI

' Gửi Request
note right of UI
  API Endpoint:
  PUT /users/profile
  Body (FormData):
  - name, bio, phone
  - avatar (file)
  - deleteAvatar (boolean)
end note
UI -> Middleware: Gửi Request (Header: Authorization Token)
activate Middleware

' Middleware xử lý
group Middleware Processing
    Middleware -> Middleware: verifyToken()\n(Xác thực user)
    Middleware -> Middleware: upload.single('avatar')\n(Xử lý file upload)
    Middleware -> Middleware: validateUpdateProfile()\n(Kiểm tra dữ liệu đầu vào)
    
    alt Validation Failed
        Middleware --> UI: Trả về lỗi 400 Bad Request\n(Thông báo lỗi validation)
    end
end group

' Chuyển sang Controller
Middleware -> Controller: updateProfile(req, res, next)
activate Controller
Controller -> Controller: Lấy userId, req.body, req.file

' Gọi xuống Service
Controller -> Service: updateProfile(userId, updateData, file)
activate Service

' Service: Tìm user
Service -> Entity: findById(userId)
activate Entity
Entity --> Service: Trả về user doc
deactivate Entity
deactivate Middleware


alt User Not Found
    Service --> Controller: Throw Error 404
    Controller --> UI: Trả về lỗi 404 Not Found
else User Found
    Service -> Service: Chuẩn bị cleanData\n(name, bio, phone)

    ' LOGIC XỬ LÝ ẢNH
    group Image Handling Logic
        alt Case 1: deleteAvatar == 'true' (Xóa ảnh)
            opt User đang có avatar cũ
                Service -> Service: getPublicIdFromUrl(user.avatar)
                Service -> Cloud: deleteFromCloudinary(publicId)
                activate Cloud
                Cloud --> Service: Xóa thành công
                deactivate Cloud
            end
            Service -> Service: cleanData.avatar = null

        else Case 2: file != null (Upload ảnh mới)
            opt User đang có avatar cũ
                Service -> Service: getPublicIdFromUrl(user.avatar)
                Service -> Cloud: deleteFromCloudinary(publicId)
                activate Cloud
                Cloud --> Service: Xóa thành công
                deactivate Cloud
            end
            
            Service -> Cloud: uploadToCloudinary(file.buffer)
            activate Cloud
            Cloud --> Service: Trả về result (secure_url)
            deactivate Cloud
            Service -> Service: cleanData.avatar = result.secure_url
        end
    end group

    ' Cập nhật Database
    Service -> Entity: findByIdAndUpdate(userId, cleanData)
    activate Entity
    Entity --> Service: Trả về updatedUser
    deactivate Entity

    ' Trả kết quả về Controller
    Service --> Controller: Return updatedUser
    deactivate Service

    ' Controller phản hồi Client
    Controller --> UI: Response 200 OK (JSON)\n{ success: true, data: updatedUser }
    deactivate Controller

    UI -> User: Hiển thị thông báo\n"Cập nhật thành công"
    deactivate UI
end
@enduml