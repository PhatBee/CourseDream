@startuml
!theme plain

' Khai báo các thành phần
actor "Guest/User" as User
boundary "Register Page UI" as UI
    control "Router & Middleware" as Middleware
    control "Auth Controller" as Controller
    participant "Auth Service" as Service
    entity ":User" as Entity
    participant "Email Service" as Mail

' ==========================================
' PHASE 1: YÊU CẦU ĐĂNG KÝ & GỬI OTP
' ==========================================
== Phase 1: Request Registration & Send OTP ==

User -> UI: Nhập Tên, Email, Pass\n(Bấm "Đăng ký")
activate UI

' Gửi Request Register
note right of UI
  API Endpoint:
  POST /api/auth/register
  Body: { name, email, password }
end note
UI -> Middleware: Gửi Request
activate Middleware

' Middleware Validate
Middleware -> Middleware: validateRegister()
alt Validation Error
    Middleware --> UI: Trả về lỗi 400
end

' Controller xử lý
Middleware -> Controller: register(req, res, next)
activate Controller
Controller -> Service: register({ name, email, password })
activate Service

' Check User đã xác thực chưa
Service -> Entity: findOne({ email, isVerified: true })
activate Entity
Entity --> Service: Trả về existingVerifiedUser
deactivate Entity

alt Email đã tồn tại & đã xác thực
    Service --> Controller: Throw Error 400 ("Email đã tồn tại")
    Controller --> UI: Hiển thị lỗi
else Email chưa tồn tại hoặc chưa xác thực
    ' Logic xử lý nội bộ Service
    Service -> Service: hashPassword(password)
    Service -> Service: otp = generateOTP()
    Service -> Service: otpExpires = Now + 15 mins

    ' Lưu DB (Upsert logic)
    note right of Service
      Sử dụng findOneAndUpdate với upsert: true
      để tạo mới hoặc cập nhật user chưa verify
    end note
    Service -> Entity: findOneAndUpdate({ email, isVerified: false }, data, { upsert: true ... })
    activate Entity
    Entity --> Service: Trả về user doc
    deactivate Entity

    ' Gửi Email
    Service -> Mail: sendEmail(to, subject, html)
    activate Mail
    Mail --> Service: Gửi thành công
    deactivate Mail

    ' Trả kết quả Phase 1
    Service --> Controller: Return { email: user.email }
    Controller --> UI: Response 200 OK\n{ message: "Mã OTP đã được gửi..." }
    deactivate Controller
    deactivate Middleware
    
    UI -> User: Chuyển sang màn hình nhập OTP
    deactivate UI
end

' ==========================================
' PHASE 2: XÁC THỰC OTP & KÍCH HOẠT
' ==========================================
== Phase 2: Verify OTP & Activate Account ==

User -> UI: Kiểm tra Email -> Nhập mã OTP
activate UI

' Gửi Request Verify
note right of UI
  API Endpoint:
  POST /api/auth/verify-otp
  Body: { email, otp }
end note
UI -> Middleware: Gửi Request
activate Middleware

Middleware -> Controller: verifyOTP(req, res, next)
activate Controller
Controller -> Service: verifyOTP({ email, otp })
activate Service

' Tìm User
Service -> Entity: findOne({ email })
activate Entity
Entity --> Service: Trả về user
deactivate Entity

alt User Not Found
    Service --> Controller: Throw Error 400 ("Email không tồn tại")
    Controller --> UI: Trả về lỗi
else User Found
    ' Các bước kiểm tra logic
    opt user.isVerified == true
        Service --> Controller: Throw Error 400 ("Đã kích hoạt")
    end
    
    opt user.otp != otp
        Service --> Controller: Throw Error 400 ("OTP không đúng")
    end
    
    opt user.otpExpires < Date.now()
        Service --> Controller: Throw Error 400 ("OTP hết hạn")
    end

    ' Kích hoạt tài khoản thành công
    Service -> Service: user.isVerified = true
    Service -> Service: Clear OTP (otp=null, expires=null)
    
    Service -> Entity: user.save()
    activate Entity
    Entity --> Service: Saved
    deactivate Entity

    ' Trả kết quả Phase 2
    Service --> Controller: Return { message: "Xác thực thành công" }
    deactivate Service

    Controller --> UI: Response 200 OK
    deactivate Controller
    deactivate Middleware

    UI -> User: Thông báo thành công\nChuyển hướng đến trang Đăng nhập
    deactivate UI
end

@enduml