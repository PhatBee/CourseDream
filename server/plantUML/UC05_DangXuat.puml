@startuml
!theme plain
autonumber

' Khai báo các thành phần tham gia
actor "User" as User
boundary "Page UI" as UI
    control "Router & Middleware" as Middleware
    control "Auth Controller" as Controller
    participant "Auth Service" as Service
    entity ":User" as Entity

' Bắt đầu luồng
User -> UI: Bấm nút "Đăng xuất"
activate UI

' Gửi Request
note right of UI
  API Endpoint:
  POST /api/auth/logout
  Cookie: refreshToken
end note
UI -> Middleware: Gửi Request
activate Middleware

' Chuyển sang Controller
Middleware -> Controller: logout(req, res, next)
activate Controller
Controller -> Controller: Lấy refreshToken từ req.cookies

' Gọi xuống Service
Controller -> Service: logout(refreshToken)
activate Service

' Service: Xử lý logic
opt refreshToken != null
    Service -> Entity: findOne({ refreshToken })
    activate Entity
    Entity --> Service: Trả về user (hoặc null)
    deactivate Entity

    opt User Found (user != null)
        Service -> Service: user.refreshToken = null
        Service -> Entity: user.save()
        activate Entity
        Entity --> Service: Success
        deactivate Entity
    end
end

' Trả kết quả về Controller
Service --> Controller: Return { message: "Đăng xuất thành công!" }
deactivate Service

' Controller xử lý Cookie & Response
Controller -> Controller: res.clearCookie('accessToken')
Controller -> Controller: res.clearCookie('refreshToken')

Controller --> UI: Response 200 OK (JSON)\n{ message: "Đăng xuất thành công!" }
deactivate Controller
deactivate Middleware

UI -> User: Chuyển hướng về trang Đăng nhập/Trang chủ
deactivate UI
@enduml